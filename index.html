<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta name="description" content="■">
	<meta name="keywords" content="■">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0">
	<link rel="stylesheet" href="css/import.css">
	<script src="js/jquery.js"></script>
	<script src="js/common.js"></script>
	<script src="js/jquery.preload.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Nunito:700,300,400' rel='stylesheet' type='text/css'>
	<script type="text/javascript">
		$(document).ready(function() {
			var api_Url = 'https://api.flickr.com/services/rest/';
			var key = 'e2d99c3ff7885e30c624973bb84fdb09';
			var itemLimit = 50;
			var page = 1;
			var usr = '126218952@N06';
			var hash = window.location.search;
			console.log(hash);
			var showSumNum = 0;
			var $nextBtn = $('p.nextbtn');
			$nextBtn.hide();

			function pageCounter(p) {
				var count = p;
				return function() {
					return count++;
				}
			}
			sumObj = pageCounter(2);

			function preloadComplate(e) {
				$('body').removeClass("load");
				for(var i = 0;i < e.imgs.length;i++) {
					$('#FlickrPhotos').append('<li class="off"><a href="' + e.imgs[i].replace("_s","") + '"><img src="' + e.imgs[i] + '"></a></li>');
					setTimeout(function () {
						$('#FlickrPhotos li').eq(showSumNum).removeClass("off");
						showSumNum++
					 },i*50);
				}
			}


			//get Tag
			function getTags() {
				getApi({
					method: ['tags','getListUser'],
					api_key: key,
					user_id: usr
				},function(tags){
					console.log(tags);
						$('#tags').append('<li><a href="'+window.location.hostname+'">all</a></li>')
						for ( i=0; i < tags.who.tags.tag.length; i ++ ) {
							$('#tags').append('<li><a href="?tags='+tags.who.tags.tag[i]._content+'">'+ tags.who.tags.tag[i]._content +'</a></li>')
						}
				});
			}

			//get Photo
			function getPhoto(c) {
				page = !c ? page :c;

				getApi({
					method: ['photos','search'],
					api_key: key,
					per_page: itemLimit,
					page: page,
					tags: hash.replace("?tags=",""),
					user_id: usr
				},function(json){
						console.log(json);
						totalCheck(json.photos.page,json.photos.perpage,json.photos.total);
						var imgPath = [];
						for ( i=0; i < json.photos.photo.length; i ++ ) {
							var farm = json.photos.photo[i].farm;
							var server = json.photos.photo[i].server;
							var secret = json.photos.photo[i].secret;
							var id = json.photos.photo[i].id;
							imgPath[i] = 'http://farm'+farm+'.staticflickr.com/'+server+'/'+id+'_'+secret+'_s.jpg';
						}
						$(window).preload({
							imgs : imgPath,
							onComplete : function(e){preloadComplate(e);},
							loadFunction : function(e){},
							timerSpeed : 10
						});
				});
			}


			function getApi(search,complate) {
				var url = api_Url + '?';

				var urlAry = [url];

				for(apiName in search) {
					if(apiName === 'method') {
						if(search[apiName]) urlAry.push(apiName + '=flickr.' + search[apiName][0] + '.' + search[apiName][1]);
					} else {
						if(search[apiName]) urlAry.push(apiName + '=' + search[apiName]);
					}
				}

				url = urlAry.join('&');

				url += '&format=json&nojsoncallback=1';
				console.log(url);
				$.ajax({
					type: 'GET',
					url: url,
					dataType: 'json',
					success : function(e){
						complate(e);
					}
				});
			}

			function totalCheck(page,perpage,total) {
				if((page * perpage) >= total) {
					$nextBtn.hide();
				} else {
					$nextBtn.show();
				}
			} 

			getTags();
			getPhoto();
			$("body").addClass("load");

			$nextBtn.click(function() {
				getPhoto(sumObj());
				$("body").addClass("load");
			});
});
	</script>
	<title>flickr-js | digi-tamari</title>
</head>
<body>
<header role="banner">
	<h1>flickr-js</h1>
	<p><span>tags</span></p>
</header>
<ul id="tags">
</ul>
<main role="main">
	
	<ul id="FlickrPhotos">
	</ul>
	<p class="nextbtn">続きを表示</p>
</main>
<footer role="contentinfo">
	<p><small>Copyright &copy; digi_tamaring All Rights Reserved.</small></p>
</footer>
</body>
</html>